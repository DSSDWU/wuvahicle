<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบขึ้นทะเบียนขอใช้รถ มหาวิทยาลัยวลัยลักษณ์</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js"></script>
    <style>
        :root { --primary-color: #8BC34A; --primary-light: #DCEDC8; --primary-dark: #689F38; --text-color: #212121; }
        body { font-family: 'Sarabun', sans-serif; background-color: #f9f9f9; color: var(--text-color); }
        .container { max-width: 800px; }
        .header { background-color: var(--primary-light); }
        .form-section { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section-title { background-color: var(--primary-light); color: var(--text-color); border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .image-preview { width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; display: none; }
        .example-link { color: #689F38; text-decoration: underline; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); padding-top: 60px; }
        .modal-content { margin: auto; display: block; width: 80%; max-width: 700px; max-height: 80vh; object-fit: contain; }
        .close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; z-index: 1001; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <div class="header flex items-center justify-center p-4 mb-6 rounded-lg">
            <img src="https://www.wu.ac.th/uploads/logoWU_1631668089.png" alt="มหาวิทยาลัยวลัยลักษณ์" class="h-16">
            <h1 class="text-2xl font-bold ml-4 text-center">ระบบขึ้นทะเบียนขอใช้รถ<br>มหาวิทยาลัยวลัยลักษณ์</h1>
        </div>
        <form id="vehicleRegistrationForm" class="space-y-6">
            <div class="form-section">
                <div class="section-title p-4 font-bold text-lg">ส่วนที่ 1: ข้อมูลส่วนตัว</div>
                <div class="p-6 space-y-4">
                    </div>
            </div>
            <div class="form-section">
                <div class="section-title p-4 font-bold text-lg">ส่วนที่ 2: ข้อมูลรถที่ขึ้นทะเบียน</div>
                <div class="p-6 space-y-4">
                     </div>
            </div>
            <div class="form-section p-6">
                <button type="submit" id="submitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md">ส่งข้อมูล</button>
            </div>
        </form>
    </div>

    <div id="exampleModal" class="modal">
        <span class="close" onclick="document.getElementById('exampleModal').style.display='none'">&times;</span>
        <img class="modal-content" id="exampleImage">
    </div>

    <script>
        // ฟังก์ชัน previewImage และ getBase64 ไม่มีการเปลี่ยนแปลง
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({ icon: 'error', title: 'ขนาดไฟล์เกินกำหนด', text: 'กรุณาอัปโหลดไฟล์ขนาดไม่เกิน 5MB' });
                    input.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
                reader.readAsDataURL(file);
            }
        }
        async function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        }

        document.getElementById('showExampleImages').onclick = () => {
            document.getElementById('exampleImage').src = "https://dssd.wu.ac.th/wp-content/uploads/2025/06/ตัวอย่างภาพถ่ายรถ-4-ด้าน.png";
            document.getElementById('exampleModal').style.display = "block";
        };

        // ⭐ [โค้ดที่แก้ไข] จัดการการส่งฟอร์มด้วยวิธีที่เสถียรขึ้น
        document.getElementById('vehicleRegistrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            // การตรวจสอบความถูกต้องของข้อมูล (Validation) สามารถคงไว้เหมือนเดิม
            // ...

            Swal.fire({
                title: 'กำลังส่งข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                // 1. สร้าง Object ข้อมูลทั้งหมดเหมือนเดิม
                const payload = {
                    studentId: document.getElementById('studentId').value,
                    fullName: document.getElementById('fullName').value,
                    faculty: document.getElementById('faculty').value,
                    phone: document.getElementById('phone').value,
                    residence: document.getElementById('residence').value,
                    address: document.getElementById('address').value,
                    emergencyContact: document.getElementById('emergencyContact').value,
                    relationship: document.getElementById('relationship').value,
                    emergencyPhone: document.getElementById('emergencyPhone').value,
                    drivingLicense: document.getElementById('drivingLicense').value,
                    vehicleType: document.getElementById('vehicleType').value,
                    brand: document.getElementById('brand').value,
                    model: document.getElementById('model').value,
                    licensePlate: document.getElementById('licensePlate').value,
                    province: document.getElementById('province').value,
                    color: document.getElementById('color').value,
                    frontImage: await getBase64(document.getElementById('frontImage').files[0]),
                    backImage: await getBase64(document.getElementById('backImage').files[0]),
                    leftImage: await getBase64(document.getElementById('leftImage').files[0]),
                    rightImage: await getBase64(document.getElementById('rightImage').files[0]),
                };

                // 2. สร้าง FormData และนำ Object ทั้งก้อนไปใส่ใน field เดียว
                const formData = new FormData();
                formData.append('payload', JSON.stringify(payload));

                // 3. ส่ง FormData ไปยัง Google Apps Script
                const response = await fetch('https://script.google.com/macros/s/AKfycbwSKHpSt_XIh1Pvuo8QCi1pNx7wblbGvQH4W7wtf7W-IjLG9FKJ1c_wlExLsC4d15E8yA/exec', {
                    method: 'POST',
                    body: formData,
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                const data = await response.json();

                if (data.result === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'ส่งข้อมูลสำเร็จ',
                        text: 'กรุณานำรถพร้อมหลักฐาน ไปรับสติกเกอร์ตามวันเวลาที่กำหนด',
                    }).then(() => {
                        e.target.reset();
                        document.querySelectorAll('.image-preview').forEach(img => img.style.display = 'none');
                    });
                } else {
                    throw new Error(data.error || 'เกิดข้อผิดพลาดในการประมวลผลข้อมูล');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message,
                });
            }
        });
    </script>
</body>
</html>
