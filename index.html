<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบขึ้นทะเบียนขอใช้รถ มหาวิทยาลัยวลัยลักษณ์</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .form-label {
            @apply block text-gray-700 text-sm font-bold mb-2;
        }
        .form-input, .form-select {
            @apply shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent;
        }
        .form-input::placeholder {
            @apply text-gray-400;
        }
        .btn-submit {
            @apply w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed;
        }
        .file-preview {
            @apply mt-2 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center;
        }
        .file-preview img {
            @apply max-h-48 mx-auto rounded-md;
        }
        .required-dot::after {
            content: ' *';
            color: red;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-3xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <img src="https://www.wu.ac.th/uploads/logoWU_1631668089.png" alt="โลโก้มหาวิทยาลัยวลัยลักษณ์" class="h-20 mx-auto mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">ระบบขึ้นทะเบียนขอใช้รถ</h1>
            <p class="text-gray-500">มหาวิทยาลัยวลัยลักษณ์</p>
        </header>

        <!-- Form -->
        <form id="registrationForm" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg space-y-6">

            <!-- Part 1: Personal Info -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-bold text-purple-700 mb-4">ส่วนที่ 1: ข้อมูลส่วนตัว</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Student ID -->
                    <div>
                        <label for="studentId" class="form-label required-dot">รหัสนักศึกษา</label>
                        <input type="text" id="studentId" name="รหัสนักศึกษา" class="form-input" placeholder="ตัวเลข 8 หลัก" required>
                        <p id="studentIdError" class="text-red-500 text-xs mt-1 hidden">กรุณากรอกรหัสนักศึกษาเป็นตัวเลข 8 หลัก</p>
                    </div>
                    <!-- Full Name -->
                    <div>
                        <label for="fullName" class="form-label required-dot">ชื่อ-สกุล</label>
                        <input type="text" id="fullName" name="ชื่อ-สกุล" class="form-input" placeholder="ชื่อ-นามสกุล" required>
                    </div>
                    <!-- School -->
                    <div class="md:col-span-2">
                        <label for="school" class="form-label required-dot">สำนักวิชา</label>
                        <select id="school" name="สำนักวิชา" class="form-select" required>
                            <option value="" disabled selected>-- กรุณาเลือกสำนักวิชา --</option>
                            <option>การจัดการ</option>
                            <option>การบัญชีและการเงิน</option>
                            <option>เทคโนโลยีการเกษตรและอุตสาหกรรมอาหาร</option>
                            <option>นิติศาสตร์</option>
                            <option>พยาบาลศาสตร์</option>
                            <option>แพทยศาสตร์</option>
                            <option>เภสัชศาสตร์</option>
                            <option>รัฐศาสตร์และรัฐประศาสนศาสตร์</option>
                            <option>วิทยาศาสตร์</option>
                            <option>วิศวกรรมศาสตร์และเทคโนโลยี</option>
                            <option>ศึกษาศาสตร์</option>
                            <option>ศิลปศาสตร์</option>
                            <option>สถาปัตยกรรมศาสตร์และการออกแบบ</option>
                            <option>สหเวชศาสตร์</option>
                            <option>สาธารณสุขศาสตร์</option>
                            <option>สารสนเทศศาสตร์</option>
                            <option>วิทยาลัยทันตแพทยศาสตร์นานาชาติ</option>
                            <option>วิทยาลัยนานาชาติ</option>
                            <option>วิทยาลัยสัตวแพทยศาสตร์อัครราชกุมารี</option>
                        </select>
                    </div>
                    <!-- Phone Number -->
                    <div>
                        <label for="phone" class="form-label required-dot">หมายเลขโทรศัพท์</label>
                        <input type="text" id="phone" name="เบอร์โทรศัพท์" class="form-input" placeholder="ตัวอย่าง 0812345678" required>
                         <p id="phoneError" class="text-red-500 text-xs mt-1 hidden">กรุณากรอกเบอร์โทรศัพท์ 10 หลัก และขึ้นต้นด้วย 0</p>
                    </div>
                    <!-- Residence -->
                    <div>
                        <label for="residence" class="form-label required-dot">ที่พักปัจจุบัน</label>
                        <select id="residence" name="ที่พักปัจจุบัน" class="form-select" required>
                            <option value="" disabled selected>-- กรุณาเลือก --</option>
                            <option>หอพักภายในมหาวิทยาลัย</option>
                            <option>หอพักภายนอกมหาวิทยาลัย</option>
                            <option>บ้านตนเอง</option>
                        </select>
                    </div>
                    <!-- Address -->
                    <div class="md:col-span-2">
                        <label for="address" class="form-label required-dot">ที่อยู่</label>
                        <textarea id="address" name="ที่อยู่" class="form-input" rows="3" placeholder="กรอกที่อยู่ปัจจุบัน" required></textarea>
                        <p class="text-xs text-gray-500 mt-1">กรณีหอพัก ให้กรอกชื่อหอพักและหมายเลขห้อง / กรณีบ้านพัก ให้กรอกบ้านเลขที่และที่อยู่</p>
                    </div>
                    <!-- Emergency Contact -->
                    <div>
                        <label for="emergencyContact" class="form-label required-dot">ผู้ติดต่อกรณีฉุกเฉิน</label>
                        <input type="text" id="emergencyContact" name="ผู้ติดต่อกรณีฉุกเฉิน" class="form-input" placeholder="ชื่อ-นามสกุล ผู้ติดต่อ" required>
                    </div>
                    <!-- Relationship -->
                    <div>
                        <label for="relationship" class="form-label required-dot">ความสัมพันธ์</label>
                        <select id="relationship" name="ความสัมพันธ์" class="form-select" required>
                            <option value="" disabled selected>-- กรุณาเลือก --</option>
                            <option>บิดา/มารดา</option>
                            <option>ผู้ปกครอง</option>
                            <option>ญาติ</option>
                            <option>เพื่อน</option>
                        </select>
                    </div>
                    <!-- Emergency Phone -->
                    <div>
                        <label for="emergencyPhone" class="form-label required-dot">เบอร์โทรศัพท์ฉุกเฉิน</label>
                        <input type="text" id="emergencyPhone" name="เบอร์โทรศัพท์ฉุกเฉิน" class="form-input" placeholder="ตัวอย่าง 0812345678" required>
                        <p id="emergencyPhoneError" class="text-red-500 text-xs mt-1 hidden">กรุณากรอกเบอร์โทรศัพท์ 10 หลัก และขึ้นต้นด้วย 0</p>
                    </div>
                    <!-- Driver License -->
                    <div>
                        <label for="driverLicense" class="form-label required-dot">ใบอนุญาตขับรถ</label>
                        <select id="driverLicense" name="ใบอนุญาตขับรถ" class="form-select" required>
                            <option value="" disabled selected>-- กรุณาเลือก --</option>
                            <option>ไม่มีใบอนุญาตขับรถที่ขอขึ้นทะเบียน</option>
                            <option>มีใบอนุญาตขับรถที่ขอขึ้นทะเบียนแล้ว</option>
                            <option>รถที่ขอขึ้นทะเบียนเป็นจักรยานไฟฟ้า</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Part 2: Vehicle Info -->
            <div class="pt-6 border-b pb-6">
                <h2 class="text-xl font-bold text-red-500 mb-4">ส่วนที่ 2: ข้อมูลรถที่ขึ้นทะเบียน</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Vehicle Type -->
                    <div>
                        <label for="vehicleType" class="form-label required-dot">ประเภทรถ</label>
                        <select id="vehicleType" name="ประเภทรถ" class="form-select" required>
                            <option value="" disabled selected>-- กรุณาเลือก --</option>
                            <option>รถยนต์ (น้ำมัน)</option>
                            <option>รถยนต์ไฟฟ้า</option>
                            <option>รถจักรยานยนต์</option>
                            <option>รถจักรยานยนต์ไฟฟ้า</option>
                            <option>รถจักรยานไฟฟ้า</option>
                        </select>
                    </div>
                    <!-- Vehicle Color -->
                    <div>
                         <label for="color" class="form-label required-dot">สีรถ</label>
                        <input type="text" id="color" name="สีรถ" class="form-input" placeholder="เช่น ดำ-แดง" required>
                        <p class="text-xs text-gray-500 mt-1">ระบุสีหลัก 1-2 สี ที่มองเห็นชัดเจน</p>
                    </div>
                    <!-- Brand -->
                    <div>
                        <label for="brand" class="form-label required-dot">ยี่ห้อรถ</label>
                        <input type="text" id="brand" name="ยี่ห้อรถ" class="form-input" placeholder="เช่น Honda, Toyota" required>
                    </div>
                    <!-- Model -->
                    <div>
                        <label for="model" class="form-label required-dot">รุ่นรถ</label>
                        <input type="text" id="model" name="รุ่นรถ" class="form-input" placeholder="เช่น Civic, Yaris" required>
                    </div>
                    <!-- License Plate -->
                    <div>
                        <label for="licensePlate" class="form-label required-dot">ทะเบียนรถ</label>
                        <input type="text" id="licensePlate" name="ทะเบียนรถ" class="form-input" placeholder="เช่น 1กข 1234" required>
                        <p class="text-xs text-gray-500 mt-1">กรณีป้ายแดงให้กรอก "ป้ายแดง" / กรณีไม่มีให้กรอก "ไม่มี"</p>
                    </div>
                    <!-- Province -->
                    <div>
                        <label for="province" class="form-label required-dot">จังหวัด</label>
                        <select id="province" name="จังหวัด" class="form-select" required>
                            <option value="" disabled selected>-- กรุณาเลือกจังหวัด --</option>
                            <option>ป้ายแดง</option>
                            <option>ไม่สามารถจดทะเบียนได้</option>
                            <option>กรุงเทพมหานคร</option><option>กระบี่</option><option>กาญจนบุรี</option><option>กาฬสินธุ์</option><option>กำแพงเพชร</option><option>ขอนแก่น</option><option>จันทบุรี</option><option>ฉะเชิงเทรา</option><option>ชลบุรี</option><option>ชัยนาท</option><option>ชัยภูมิ</option><option>ชุมพร</option><option>เชียงราย</option><option>เชียงใหม่</option><option>ตรัง</option><option>ตราด</option><option>ตาก</option><option>นครนายก</option><option>นครปฐม</option><option>นครพนม</option><option>นครราชสีมา</option><option>นครศรีธรรมราช</option><option>นครสวรรค์</option><option>นนทบุรี</option><option>นราธิวาส</option><option>น่าน</option><option>บึงกาฬ</option><option>บุรีรัมย์</option><option>ปทุมธานี</option><option>ประจวบคีรีขันธ์</option><option>ปราจีนบุรี</option><option>ปัตตานี</option><option>พระนครศรีอยุธยา</option><option>พะเยา</option><option>พังงา</option><option>พัทลุง</option><option>พิจิตร</option><option>พิษณุโลก</option><option>เพชรบุรี</option><option>เพชรบูรณ์</option><option>แพร่</option><option>ภูเก็ต</option><option>มหาสารคาม</option><option>มุกดาหาร</option><option>แม่ฮ่องสอน</option><option>ยโสธร</option><option>ยะลา</option><option>ร้อยเอ็ด</option><option>ระนอง</option><option>ระยอง</option><option>ราชบุรี</option><option>ลพบุรี</option><option>ลำปาง</option><option>ลำพูน</option><option>เลย</option><option>ศรีสะเกษ</option><option>สกลนคร</option><option>สงขลา</option><option>สตูล</option><option>สมุทรปราการ</option><option>สมุทรสงคราม</option><option>สมุทรสาคร</option><option>สระแก้ว</option><option>สระบุรี</option><option>สิงห์บุรี</option><option>สุโขทัย</option><option>สุพรรณบุรี</option><option>สุราษฎร์ธานี</option><option>สุรินทร์</option><option>หนองคาย</option><option>หนองบัวลำภู</option><option>อ่างทอง</option><option>อำนาจเจริญ</option><option>อุดรธานี</option><option>อุตรดิตถ์</option><option>อุทัยธานี</option><option>อุบลราชธานี</option>
                        </select>
                    </div>
                </div>
                 <!-- File Uploads -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <!-- Front Photo -->
                    <div>
                        <label for="photoFront" class="form-label required-dot">ภาพถ่ายรถด้านหน้า</label>
                        <input type="file" id="photoFront" name="ภาพถ่ายรถด้านหน้า" class="form-input" accept="image/*" required onchange="previewImage(this, 'previewFront')">
                        <div id="previewFront" class="file-preview">
                            <span class="text-gray-500">ขนาดไม่เกิน 10MB</span>
                        </div>
                    </div>
                    <!-- Rear Photo -->
                    <div>
                        <label for="photoRear" class="form-label required-dot">ภาพถ่ายรถด้านหลัง</label>
                        <input type="file" id="photoRear" name="ภาพถ่ายรถด้านหลัง" class="form-input" accept="image/*" required onchange="previewImage(this, 'previewRear')">
                        <div id="previewRear" class="file-preview">
                            <span class="text-gray-500">ขนาดไม่เกิน 10MB</span>
                        </div>
                    </div>
                    <!-- Left Photo -->
                    <div>
                        <label for="photoLeft" class="form-label required-dot">ภาพถ่ายรถด้านซ้าย</label>
                        <input type="file" id="photoLeft" name="ภาพถ่ายรถด้านซ้าย" class="form-input" accept="image/*" required onchange="previewImage(this, 'previewLeft')">
                        <div id="previewLeft" class="file-preview">
                            <span class="text-gray-500">ขนาดไม่เกิน 10MB</span>
                        </div>
                    </div>
                    <!-- Right Photo -->
                    <div>
                        <label for="photoRight" class="form-label required-dot">ภาพถ่ายรถด้านขวา</label>
                        <input type="file" id="photoRight" name="ภาพถ่ายรถด้านขวา" class="form-input" accept="image/*" required onchange="previewImage(this, 'previewRight')">
                        <div id="previewRight" class="file-preview">
                            <span class="text-gray-500">ขนาดไม่เกิน 10MB</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confirmation -->
            <div class="pt-6 space-y-4">
                <div class="flex items-start">
                    <input id="confirmation" type="checkbox" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500 mt-1">
                    <label for="confirmation" class="ml-3 text-sm text-gray-700">
                        ขอรับรองว่าข้อมูลถูกต้องและเป็นความจริงทุกประการ หากมีเจตนาให้ข้อมูลเท็จ ข้าพเจ้ายินดีรับโทษตามระเบียบและข้อบังคับของมหาวิทยาลัยทุกประการ
                    </label>
                </div>
                <!-- Submit Button -->
                <button type="submit" id="submitButton" class="btn-submit" disabled>ส่งข้อมูล</button>
            </div>
        </form>
    </div>

    <script>
        // --- CONFIGURATION ---
        // !!! สำคัญ: แก้ไข URL นี้เป็น URL ของ Web App ที่ได้จากการ Deploy บน Google Apps Script !!!
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxamZZuigROMps_aw8bRCVkTkSCLdetdO5LLjk_GETtXWrUVs0OS39PjTpHkEeSvFzb9g/exec';
        
        // --- ELEMENTS ---
        const form = document.getElementById('registrationForm');
        const submitButton = document.getElementById('submitButton');
        const confirmationCheckbox = document.getElementById('confirmation');
        const studentIdInput = document.getElementById('studentId');
        const phoneInput = document.getElementById('phone');
        const emergencyPhoneInput = document.getElementById('emergencyPhone');

        // --- VALIDATION ---
        const validateStudentId = () => {
            const value = studentIdInput.value;
            const errorEl = document.getElementById('studentIdError');
            const isValid = /^\d{8}$/.test(value);
            errorEl.classList.toggle('hidden', isValid);
            return isValid;
        };

        const validatePhone = (inputElement, errorElementId) => {
            const value = inputElement.value;
            const errorEl = document.getElementById(errorElementId);
            const isValid = /^0\d{9}$/.test(value);
            errorEl.classList.toggle('hidden', isValid);
            return isValid;
        };

        studentIdInput.addEventListener('input', validateStudentId);
        phoneInput.addEventListener('input', () => validatePhone(phoneInput, 'phoneError'));
        emergencyPhoneInput.addEventListener('input', () => validatePhone(emergencyPhoneInput, 'emergencyPhoneError'));

        // --- FORM LOGIC ---
        confirmationCheckbox.addEventListener('change', () => {
            submitButton.disabled = !confirmationCheckbox.checked;
        });

        const fileInputs = [
            document.getElementById('photoFront'),
            document.getElementById('photoRear'),
            document.getElementById('photoLeft'),
            document.getElementById('photoRight')
        ];

        const getFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        const validateForm = () => {
            // Check standard validity
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }
            // Check custom validation
            const isStudentIdValid = validateStudentId();
            const isPhoneValid = validatePhone(phoneInput, 'phoneError');
            const isEmergencyPhoneValid = validatePhone(emergencyPhoneInput, 'emergencyPhoneError');

            if (!isStudentIdValid || !isPhoneValid || !isEmergencyPhoneValid) {
                Swal.fire({
                    icon: 'error',
                    title: 'ข้อมูลไม่ถูกต้อง',
                    text: 'กรุณาตรวจสอบข้อมูลที่มีการแจ้งเตือน (สีแดง) และกรอกให้ถูกต้อง',
                });
                return false;
            }
            return true;
        }

        // --- FORM SUBMISSION ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!validateForm()) return;

            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                html: 'กรุณารอสักครู่ ระบบกำลังอัปโหลดไฟล์และบันทึกข้อมูล',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => data[key] = value);

                // Handle file uploads
                const filePromises = fileInputs.map(async (input) => {
                    if (input.files[0]) {
                        const file = input.files[0];
                        const base64 = await getFileAsBase64(file);
                        return { 
                            name: input.name, 
                            base64: base64,
                            type: file.type,
                            filename: file.name
                        };
                    }
                    return null;
                });
                
                const files = (await Promise.all(filePromises)).filter(f => f !== null);
                data.files = files;
                
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'cors', // Important for cross-origin requests
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Send as text/plain to be parsed by Apps Script
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกข้อมูลสำเร็จ!',
                        html: `ข้อมูลของคุณถูกบันทึกเรียบร้อยแล้ว<br>Folder: <a href="${result.folderUrl}" target="_blank" class="text-blue-500 hover:underline">คลิกเพื่อดูโฟลเดอร์</a>`,
                    });
                    form.reset();
                    // Reset previews
                    ['previewFront', 'previewRear', 'previewLeft', 'previewRight'].forEach(id => {
                        const preview = document.getElementById(id);
                        preview.innerHTML = '<span class="text-gray-500">ขนาดไม่เกิน 10MB</span>';
                    });
                    confirmationCheckbox.checked = false;
                    submitButton.disabled = true;
                } else {
                    throw new Error(result.message || 'เกิดข้อผิดพลาดที่ไม่รู้จัก');
                }

            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด!',
                    text: 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message,
                });
            }
        });

        // --- IMAGE PREVIEW ---
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            
            if (file) {
                 if (file.size > 10 * 1024 * 1024) { // 10 MB
                    Swal.fire({
                        icon: 'warning',
                        title: 'ไฟล์มีขนาดใหญ่เกินไป',
                        text: 'กรุณาเลือกไฟล์ภาพที่มีขนาดไม่เกิน 10MB',
                    });
                    input.value = ''; // Clear the selected file
                    preview.innerHTML = '<span class="text-gray-500">ขนาดไม่เกิน 10MB</span>';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Image preview"/>`;
                }
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '<span class="text-gray-500">ขนาดไม่เกิน 10MB</span>';
            }
        }
    </script>
</body>
</html>
