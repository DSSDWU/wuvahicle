<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบขึ้นทะเบียนขอใช้รถ มหาวิทยาลัยวลัยลักษณ์</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Custom Styles -->
    <style>
        body {
            background-color: #f0fdf4; /* Pastel Green Background */
            font-family: 'Sarabun', sans-serif; /* Recommended Thai Font */
        }
        .form-container {
            background-color: white;
            border: 1px solid black;
        }
        .form-input, .form-select {
            border: 1px solid #000;
            transition: all 0.3s ease-in-out;
        }
        .form-input:focus, .form-select:focus {
            border-color: #22c55e; /* Green-500 */
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.4);
            outline: none;
        }
        .btn-submit {
            background-color: #22c55e; /* Green-500 */
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-submit:hover {
            background-color: #16a34a; /* Green-600 */
        }
        .btn-submit:disabled {
            background-color: #a1a1aa; /* Gray-400 */
            cursor: not-allowed;
        }
        .image-preview {
            width: 150px;
            height: 100px;
            border: 1px dashed #ccc;
            background-color: #f9fafb;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <!-- Header Logo -->
        <div class="flex justify-center mb-6">
            <img src="https://www.wu.ac.th/uploads/logoWU_1631668089.png" alt="Walailak University Logo" class="h-20">
        </div>

        <div class="form-container shadow-lg rounded-xl p-6 md:p-8">
            <h1 class="text-2xl md:text-3xl font-bold text-center mb-2 text-gray-800">ระบบขึ้นทะเบียนขอใช้รถ</h1>
            <p class="text-center text-gray-600 mb-8">มหาวิทยาลัยวลัยลักษณ์</p>

            <form id="vehicleForm">
                <!-- Section 1: Personal Information -->
                <fieldset class="border-t-2 border-green-500 pt-6 mb-8">
                    <legend class="text-xl font-bold px-2 text-gray-700">ส่วนที่ 1: ข้อมูลส่วนตัว</legend>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label for="studentId" class="block text-sm font-medium text-gray-700">รหัสนักศึกษา <span class="text-red-500">*</span></label>
                            <input type="text" id="studentId" name="studentId" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700">ชื่อ-สกุล <span class="text-red-500">*</span></label>
                            <input type="text" id="fullName" name="fullName" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="faculty" class="block text-sm font-medium text-gray-700">สำนักวิชา <span class="text-red-500">*</span></label>
                            <select id="faculty" name="faculty" class="form-select mt-1 block w-full rounded-md shadow-sm" required>
                                <option value="" disabled selected>-- กรุณาเลือก --</option>
                                <option value="การจัดการ">การจัดการ</option>
                                <option value="การบัญชีและการเงิน">การบัญชีและการเงิน</option>
                                <option value="เทคโนโลยีการเกษตรและอุตสาหกรรมอาหาร">เทคโนโลยีการเกษตรและอุตสาหกรรมอาหาร</option>
                                <option value="นิติศาสตร์">นิติศาสตร์</option>
                                <option value="พยาบาลศาสตร์">พยาบาลศาสตร์</option>
                                <option value="แพทยศาสตร์">แพทยศาสตร์</option>
                                <option value="เภสัชศาสตร์">เภสัชศาสตร์</option>
                                <option value="รัฐศาสตร์และรัฐประศาสนศาสตร์">รัฐศาสตร์และรัฐประศาสนศาสตร์</option>
                                <option value="วิทยาศาสตร์">วิทยาศาสตร์</option>
                                <option value="วิศวกรรมศาสตร์และเทคโนโลยี">วิศวกรรมศาสตร์และเทคโนโลยี</option>
                                <option value="ศึกษาศาสตร์">ศึกษาศาสตร์</option>
                                <option value="ศิลปศาสตร์">ศิลปศาสตร์</option>
                                <option value="สถาปัตยกรรมศาสตร์และการออกแบบ">สถาปัตยกรรมศาสตร์และการออกแบบ</option>
                                <option value="สหเวชศาสตร์">สหเวชศาสตร์</option>
                                <option value="สาธารณสุขศาสตร์">สาธารณสุขศาสตร์</option>
                                <option value="สารสนเทศศาสตร์">สารสนเทศศาสตร์</option>
                                <option value="วิทยาลัยทันตแพทยศาสตร์นานาชาติ">วิทยาลัยทันตแพทยศาสตร์นานาชาติ</option>
                                <option value="วิทยาลัยนานาชาติ">วิทยาลัยนานาชาติ</option>
                                <option value="วิทยาลัยสัตวแพทยศาสตร์อัครราชกุมารี">วิทยาลัยสัตวแพทยศาสตร์อัครราชกุมารี</option>
                            </select>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">หมายเลขโทรศัพท์ <span class="text-red-500">*</span></label>
                            <input type="text" id="phone" name="phone" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                        </div>
                         <div>
                            <label for="residence" class="block text-sm font-medium text-gray-700">ที่พักปัจจุบัน <span class="text-red-500">*</span></label>
                            <select id="residence" name="residence" class="form-select mt-1 block w-full rounded-md shadow-sm" required>
                                <option value="" disabled selected>-- กรุณาเลือก --</option>
                                <option value="หอพักภายในมหาวิทยาลัย">หอพักภายในมหาวิทยาลัย</option>
                                <option value="หอพักภายนอกมหาวิทยาลัย">หอพักภายนอกมหาวิทยาลัย</option>
                                <option value="บ้านตนเอง">บ้านตนเอง</option>
                            </select>
                        </div>
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700">ที่อยู่ <span class="text-red-500">*</span></label>
                            <input type="text" id="address" name="address" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                            <p class="mt-1 text-xs text-gray-500">กรณีหอพัก ให้กรอกชื่อหอพักและหมายเลขห้อง / กรณีบ้านพัก ให้กรอกบ้านเลขที่และที่อยู่</p>
                        </div>
                        <div>
                            <label for="emergencyContact" class="block text-sm font-medium text-gray-700">ผู้ติดต่อกรณีฉุกเฉิน <span class="text-red-500">*</span></label>
                            <input type="text" id="emergencyContact" name="emergencyContact" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="relationship" class="block text-sm font-medium text-gray-700">ความสัมพันธ์ <span class="text-red-500">*</span></label>
                            <select id="relationship" name="relationship" class="form-select mt-1 block w-full rounded-md shadow-sm" required>
                                <option value="" disabled selected>-- กรุณาเลือก --</option>
                                <option value="บิดา/มารดา">บิดา/มารดา</option>
                                <option value="ผู้ปกครอง">ผู้ปกครอง</option>
                                <option value="ญาติ">ญาติ</option>
                                <option value="เพื่อน">เพื่อน</option>
                            </select>
                        </div>
                        <div>
                            <label for="emergencyPhone" class="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์ฉุกเฉิน <span class="text-red-500">*</span></label>
                            <input type="text" id="emergencyPhone" name="emergencyPhone" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="license" class="block text-sm font-medium text-gray-700">ใบอนุญาตขับรถ <span class="text-red-500">*</span></label>
                            <select id="license" name="license" class="form-select mt-1 block w-full rounded-md shadow-sm" required>
                                <option value="" disabled selected>-- กรุณาเลือก --</option>
                                <option value="ไม่มีใบอนุญาตขับรถที่ขอขึ้นทะเบียน">ไม่มีใบอนุญาตขับรถที่ขอขึ้นทะเบียน</option>
                                <option value="มีใบอนุญาตขับรถที่ขอขึ้นทะเบียนแล้ว">มีใบอนุญาตขับรถที่ขอขึ้นทะเบียนแล้ว</option>
                                <option value="รถที่ขอขึ้นทะเบียนเป็นจักรยานไฟฟ้า">รถที่ขอขึ้นทะเบียนเป็นจักรยานไฟฟ้า</option>
                            </select>
                        </div>
                    </div>
                </fieldset>

                <!-- Section 2: Vehicle Information -->
                <fieldset class="border-t-2 border-green-500 pt-6 mb-8">
                    <legend class="text-xl font-bold px-2 text-gray-700">ส่วนที่ 2: ข้อมูลรถที่ขึ้นทะเบียน</legend>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label for="vehicleType" class="block text-sm font-medium text-gray-700">ประเภทรถ <span class="text-red-500">*</span></label>
                            <select id="vehicleType" name="vehicleType" class="form-select mt-1 block w-full rounded-md shadow-sm" required>
                                <option value="" disabled selected>-- กรุณาเลือก --</option>
                                <option value="รถยนต์(น้ำมัน)">รถยนต์(น้ำมัน)</option>
                                <option value="รถยนต์ไฟฟ้า">รถยนต์ไฟฟ้า</option>
                                <option value="รถจักรยานยนต์ไฟฟ้า">รถจักรยานยนต์ไฟฟ้า</option>
                                <option value="รถจักรยานไฟฟ้า">รถจักรยานไฟฟ้า</option>
                            </select>
                        </div>
                        <div>
                            <label for="make" class="block text-sm font-medium text-gray-700">ยี่ห้อรถ <span class="text-red-500">*</span></label>
                            <input type="text" id="make" name="make" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="model" class="block text-sm font-medium text-gray-700">รุ่นรถ <span class="text-red-500">*</span></label>
                            <input type="text" id="model" name="model" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                        </div>
                        <div>
                            <label for="licensePlate" class="block text-sm font-medium text-gray-700">ทะเบียนรถ <span class="text-red-500">*</span></label>
                            <input type="text" id="licensePlate" name="licensePlate" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                            <p class="mt-1 text-xs text-gray-500">ป้ายแดงกรอก "ป้ายแดง" / รถไม่มีทะเบียนกรอก "ไม่สามารถจดทะเบียนได้"</p>
                        </div>
                        <div>
                            <label for="province" class="block text-sm font-medium text-gray-700">จังหวัด <span class="text-red-500">*</span></label>
                            <select id="province" name="province" class="form-select mt-1 block w-full rounded-md shadow-sm" required>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="color" class="block text-sm font-medium text-gray-700">สีรถ <span class="text-red-500">*</span></label>
                            <input type="text" id="color" name="color" class="form-input mt-1 block w-full rounded-md shadow-sm" required>
                            <p class="mt-1 text-xs text-gray-500">สีตามคู่มือรถ หรือสีที่เห็นชัดเจนที่สุด 2 สี</p>
                        </div>
                    </div>

                    <!-- File Uploads -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                        <div>
                            <label for="photoFront" class="block text-sm font-medium text-gray-700">ภาพถ่ายรถด้านหน้า <span class="text-red-500">*</span></label>
                            <input type="file" id="photoFront" name="photoFront" accept="image/*" class="form-input mt-1 block w-full text-sm" required onchange="previewImage(event, 'previewFront')">
                            <div id="previewFront" class="image-preview"><span>พรีวิว</span></div>
                        </div>
                        <div>
                            <label for="photoBack" class="block text-sm font-medium text-gray-700">ภาพถ่ายรถด้านหลัง <span class="text-red-500">*</span></label>
                            <input type="file" id="photoBack" name="photoBack" accept="image/*" class="form-input mt-1 block w-full text-sm" required onchange="previewImage(event, 'previewBack')">
                            <div id="previewBack" class="image-preview"><span>พรีวิว</span></div>
                        </div>
                        <div>
                            <label for="photoLeft" class="block text-sm font-medium text-gray-700">ภาพถ่ายรถด้านซ้าย <span class="text-red-500">*</span></label>
                            <input type="file" id="photoLeft" name="photoLeft" accept="image/*" class="form-input mt-1 block w-full text-sm" required onchange="previewImage(event, 'previewLeft')">
                            <div id="previewLeft" class="image-preview"><span>พรีวิว</span></div>
                        </div>
                        <div>
                            <label for="photoRight" class="block text-sm font-medium text-gray-700">ภาพถ่ายรถด้านขวา <span class="text-red-500">*</span></label>
                            <input type="file" id="photoRight" name="photoRight" accept="image/*" class="form-input mt-1 block w-full text-sm" required onchange="previewImage(event, 'previewRight')">
                            <div id="previewRight" class="image-preview"><span>พรีวิว</span></div>
                        </div>
                    </div>
                </fieldset>

                <!-- Confirmation -->
                <div class="mt-8">
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="confirmation" name="confirmation" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded" required>
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="confirmation" class="font-medium text-gray-700">ขอรับรองว่าข้อมูลถูกต้องและเป็นความจริงทุกประการ หากมีเจตนาให้ข้อมูลเท็จ ข้าพเจ้ายินดีรับโทษตามระเบียบและข้อบังคับของมหาวิทยาลัยทุกประการ <span class="text-red-500">*</span></label>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="mt-8 text-center">
                    <button type="submit" id="submitButton" class="btn-submit w-full md:w-1/2 lg:w-1/3 py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium">
                        ส่งข้อมูล
                    </button>
                </div>
            </form>
        </div>
        <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
            พัฒนาโดย ส่วนสารสนเทศและวิทยาการข้อมูล มหาวิทยาลัยวลัยลักษณ์
        </footer>
    </div>

    <script>
        // --- JavaScript Logic ---

        // Populate provinces dropdown
        const provinces = [
            "ป้ายแดง", "ไม่สามารถจดทะเบียนได้", "กรุงเทพมหานคร", "กระบี่", "กาญจนบุรี", "กาฬสินธุ์", "กำแพงเพชร", "ขอนแก่น", "จันทบุรี", "ฉะเชิงเทรา", "ชลบุรี", "ชัยนาท", "ชัยภูมิ", "ชุมพร", "เชียงราย", "เชียงใหม่", "ตรัง", "ตราด", "ตาก", "นครนายก", "นครปฐม", "นครพนม", "นครราชสีมา", "นครศรีธรรมราช", "นครสวรรค์", "นนทบุรี", "นราธิวาส", "น่าน", "บึงกาฬ", "บุรีรัมย์", "ปทุมธานี", "ประจวบคีรีขันธ์", "ปราจีนบุรี", "ปัตตานี", "พระนครศรีอยุธยา", "พะเยา", "พังงา", "พัทลุง", "พิจิตร", "พิษณุโลก", "เพชรบุรี", "เพชรบูรณ์", "แพร่", "ภูเก็ต", "มหาสารคาม", "มุกดาหาร", "แม่ฮ่องสอน", "ยโสธร", "ยะลา", "ร้อยเอ็ด", "ระนอง", "ระยอง", "ราชบุรี", "ลพบุรี", "ลำปาง", "ลำพูน", "เลย", "ศรีสะเกษ", "สกลนคร", "สงขลา", "สตูล", "สมุทรปราการ", "สมุทรสงคราม", "สมุทรสาคร", "สระแก้ว", "สระบุรี", "สิงห์บุรี", "สุโขทัย", "สุพรรณบุรี", "สุราษฎร์ธานี", "สุรินทร์", "หนองคาย", "หนองบัวลำภู", "อ่างทอง", "อำนาจเจริญ", "อุดรธานี", "อุตรดิตถ์", "อุทัยธานี", "อุบลราชธานี"
        ];
        const provinceSelect = document.getElementById('province');
        provinces.forEach(p => {
            const option = document.createElement('option');
            option.value = p;
            option.textContent = p;
            provinceSelect.appendChild(option);
        });
        provinceSelect.value = "นครศรีธรรมราช"; // Default value

        // Image preview function
        function previewImage(event, previewId) {
            const reader = new FileReader();
            const previewContainer = document.getElementById(previewId);
            
            reader.onload = function(){
                previewContainer.innerHTML = ''; // Clear previous preview
                const img = document.createElement('img');
                img.src = reader.result;
                previewContainer.appendChild(img);
            };
            
            if (event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            } else {
                 previewContainer.innerHTML = '<span>พรีวิว</span>';
            }
        }

        // Form submission handler
        const form = document.getElementById('vehicleForm');
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // --- Validation ---
            const studentId = document.getElementById('studentId').value;
            if (!/^\d{8}$/.test(studentId)) {
                Swal.fire('ผิดพลาด!', 'รหัสนักศึกษาต้องเป็นตัวเลข 8 หลักเท่านั้น', 'error');
                return;
            }

            const phone = document.getElementById('phone').value;
            if (!/^0\d{9}$/.test(phone)) {
                Swal.fire('ผิดพลาด!', 'หมายเลขโทรศัพท์ต้องเป็นตัวเลข 10 หลัก และขึ้นต้นด้วย 0', 'error');
                return;
            }

            const emergencyPhone = document.getElementById('emergencyPhone').value;
            if (!/^0\d{9}$/.test(emergencyPhone)) {
                Swal.fire('ผิดพลาด!', 'เบอร์โทรศัพท์ฉุกเฉินต้องเป็นตัวเลข 10 หลัก และขึ้นต้นด้วย 0', 'error');
                return;
            }

            // --- File Size Validation ---
            const files = [
                document.getElementById('photoFront').files[0],
                document.getElementById('photoBack').files[0],
                document.getElementById('photoLeft').files[0],
                document.getElementById('photoRight').files[0]
            ];

            for (const file of files) {
                if (file && file.size > 10 * 1024 * 1024) { // 10 MB
                    Swal.fire('ผิดพลาด!', `ไฟล์ ${file.name} มีขนาดใหญ่เกิน 10MB`, 'error');
                    return;
                }
            }
            
            // Show loading alert
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // --- File to Base64 Conversion ---
            const fileToBase64 = file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({
                    base64: reader.result,
                    name: file.name,
                    type: file.type
                });
                reader.onerror = error => reject(error);
            });

            try {
                const [photoFront, photoBack, photoLeft, photoRight] = await Promise.all([
                    fileToBase64(files[0]),
                    fileToBase64(files[1]),
                    fileToBase64(files[2]),
                    fileToBase64(files[3])
                ]);

                // --- Collect Form Data ---
                const formData = {
                    studentId: studentId,
                    fullName: document.getElementById('fullName').value,
                    faculty: document.getElementById('faculty').value,
                    phone: phone,
                    residence: document.getElementById('residence').value,
                    address: document.getElementById('address').value,
                    emergencyContact: document.getElementById('emergencyContact').value,
                    relationship: document.getElementById('relationship').value,
                    emergencyPhone: emergencyPhone,
                    license: document.getElementById('license').value,
                    vehicleType: document.getElementById('vehicleType').value,
                    make: document.getElementById('make').value,
                    model: document.getElementById('model').value,
                    licensePlate: document.getElementById('licensePlate').value,
                    province: document.getElementById('province').value,
                    color: document.getElementById('color').value,
                    photoFront: photoFront,
                    photoBack: photoBack,
                    photoLeft: photoLeft,
                    photoRight: photoRight
                };

                // --- Send data to Google Apps Script ---
                // !!! สำคัญ: ต้องนำ URL ที่ได้จากการ Deploy Google Apps Script มาวางที่นี่ !!!
                const gasUrl = "https://script.google.com/macros/s/AKfycbww8bQCheULKYlYAirHpp8kZAPmhDRN2MIw4_gLLEllpoVEuxqaH_cJeHWN6a8tsUTAaA/exec";

                const response = await fetch(gasUrl, {
                    method: 'POST',
                    // Using text/plain to avoid CORS preflight issues with simple triggers
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    Swal.fire({
                        title: 'บันทึกสำเร็จ!',
                        text: 'ข้อมูลของท่านถูกบันทึกเรียบร้อยแล้ว',
                        icon: 'success',
                        timer: 3000,
                        timerProgressBar: true
                    });
                    form.reset();
                    // Clear previews
                    document.getElementById('previewFront').innerHTML = '<span>พรีวิว</span>';
                    document.getElementById('previewBack').innerHTML = '<span>พรีวิว</span>';
                    document.getElementById('previewLeft').innerHTML = '<span>พรีวิว</span>';
                    document.getElementById('previewRight').innerHTML = '<span>พรีวิว</span>';

                } else {
                    throw new Error(result.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }

            } catch (error) {
                console.error('Submission Error:', error);
                Swal.fire(
                    'เกิดข้อผิดพลาด!',
                    `ไม่สามารถส่งข้อมูลได้: ${error.message}`,
                    'error'
                );
            }
        });
    </script>

</body>
</html>
