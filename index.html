// --- การตั้งค่าที่สำคัญ ---
const SHEET_ID = '1kCOvVdb8DTXTpD5H8amQKywG-Eqb7PFrPFYyyabycOc';
const SHEET_NAME = 'vahicle';
const IMAGE_FOLDER_ID = '1-0N_GZ-g-3qf8UaR4j4i3O-vD4nBwP9s'; // ID โฟลเดอร์ที่ถูกต้องจากสคริปต์ของคุณ

// --- สิ้นสุดการตั้งค่า ---


/**
 * ฟังก์ชันสำหรับรับข้อมูลที่ส่งมาจากฟอร์ม HTML (POST Request ในรูปแบบ JSON)
 */
function doPost(e) {
  try {
    // อ่านข้อมูล JSON ที่ถูกส่งมา
    const data = JSON.parse(e.postData.contents);
    
    const folder = DriveApp.getFolderById(IMAGE_FOLDER_ID);
    const folderUrl = folder.getUrl();

    // อัปโหลดรูปภาพและรับ URL กลับมา
    const frontImageUrl = saveBase64ImageToDrive(data.frontImage, `front_${data.studentId}_${new Date().getTime()}`, folder);
    const backImageUrl = saveBase64ImageToDrive(data.backImage, `back_${data.studentId}_${new Date().getTime()}`, folder);
    const leftImageUrl = saveBase64ImageToDrive(data.leftImage, `left_${data.studentId}_${new Date().getTime()}`, folder);
    const rightImageUrl = saveBase64ImageToDrive(data.rightImage, `right_${data.studentId}_${new Date().getTime()}`, folder);

    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      throw new Error(`ไม่พบชีตที่ชื่อ "${SHEET_NAME}"`);
    }

    // จัดเรียงข้อมูลให้ตรงกับโครงสร้างคอลัมน์ A-V
    const newRow = [
      new Date(),                 // A: วันที่บันทึก
      data.studentId,             // B: รหัสนักศึกษา
      data.fullName,              // C: ชื่อ-สกุล
      data.faculty,               // D: สำนักวิชา
      data.phone,                 // E: เบอร์โทรศัพท์
      data.residence,             // F: ที่พักปัจจุบัน
      data.address,               // G: ที่อยู่
      data.emergencyContact,      // H: ผู้ติดต่อกรณีฉุกเฉิน
      data.relationship,          // I: ความสัมพันธ์
      data.emergencyPhone,        // J: เบอร์โทรศัพท์ฉุกเฉิน
      data.drivingLicense,        // K: ใบอนุญาตขับรถ
      data.vehicleType,           // L: ประเภทรถ
      data.brand,                 // M: ยี่ห้อรถ
      data.model,                 // N: รุ่นรถ
      data.licensePlate,          // O: ทะเบียนรถ
      data.province,              // P: จังหวัด
      data.color,                 // Q: สีรถ
      frontImageUrl,              // R: URL รูปด้านหน้า
      backImageUrl,               // S: URL รูปด้านหลัง
      leftImageUrl,               // T: URL รูปด้านซ้าย
      rightImageUrl,              // U: URL รูปด้านขวา
      folderUrl                   // V: โฟลเดอร์รวมรูป
    ];
    
    sheet.appendRow(newRow);

    // ส่งผลลัพธ์ว่าสำเร็จกลับไปให้ HTML
    return ContentService
      .createTextOutput(JSON.stringify({ result: 'success' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log('Error in doPost: ' + error.toString());
    // ส่งผลลัพธ์ว่าเกิดข้อผิดพลาดกลับไป พร้อมข้อความ Error
    return ContentService
      .createTextOutput(JSON.stringify({ result: 'error', error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ฟังก์ชันเสริมสำหรับแปลง base64 string เป็นไฟล์รูปภาพและบันทึกลงใน Drive
 */
function saveBase64ImageToDrive(base64Data, fileName, folder) {
  if (!base64Data || base64Data.length === 0) {
    return '';
  }
  try {
    const parts = base64Data.split(',');
    if (parts.length < 2) return ''; // ตรวจสอบว่า base64 string สมบูรณ์
    const mimeType = parts[0].match(/:(.*?);/)[1];
    const decodedData = Utilities.base64Decode(parts[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const file = folder.createFile(blob);
    return file.getUrl();
  } catch (e) {
    Logger.log('Could not save image: ' + e.toString());
    return 'Error saving image';
  }
}

// --- โค้ดส่วน doGet และอื่นๆ ไม่มีการเปลี่ยนแปลง ---
function doGet(e) {
  try {
    const callback = e.parameter.callback;
    const searchType = e.parameter.searchType;
    const searchValue = e.parameter.searchValue;
    if (!callback || !searchType || !searchValue) {
      return createErrorResponse(callback, 'Missing required parameters.');
    }
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    if (!sheet) {
      return createErrorResponse(callback, `Sheet with name "${SHEET_NAME}" was not found.`);
    }
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 22).getValues();
    const columnMap = {
      studentId: 1,
      licensePlate: 14,
      brand: 12,
    };
    const results = data.filter(row => {
      if (searchType === 'licensePlate') {
        const plateNumber = row[14] ? row[14].toString().trim() : '';
        const province = row[15] ? row[15].toString().trim() : '';
        const fullLicensePlate = `${plateNumber}${province}`;
        return fullLicensePlate.toLowerCase().includes(searchValue.toLowerCase());
      }
      const searchColumnIndex = columnMap[searchType];
      if (searchColumnIndex === undefined) return false;
      const cellValue = row[searchColumnIndex] ? row[searchColumnIndex].toString().trim() : '';
      if (!cellValue) return false;
      if (searchType === 'studentId') {
        return cellValue === searchValue;
      }
      return cellValue.toLowerCase().includes(searchValue.toLowerCase());
    }).map(row => {
      return {
        studentIdName: `${row[1] || ''}, ${row[2] || ''}`,
        school: row[3],
        phone: row[4],
        residence: row[5],
        emergencyContact: row[7],
        emergencyPhone: row[9],
        vehicleType: row[11],
        brand: row[12],
        model: row[13],
        licensePlate: `${row[14] || ''} ${row[15] || ''}`.trim(),
        color: row[16],
        imgFront: row[17],
        imgBack: row[18],
        imgLeft: row[19],
        imgRight: row[20],
        studentId: row[1],
        name: row[2]
      };
    });
    const json = JSON.stringify(results);
    const output = ContentService.createTextOutput(`${callback}(${json})`);
    output.setMimeType(ContentService.MimeType.JAVASCRIPT);
    return output;
  } catch (error) {
    Logger.log(error.toString());
    const callback = e.parameter.callback || 'errorCallback';
    return createErrorResponse(callback, 'An internal server error occurred. Check script logs.');
  }
}

function createErrorResponse(callback, message) {
  const errorObject = { error: true, message: message };
  const json = JSON.stringify(errorObject);
  const output = ContentService.createTextOutput(`${callback}(${json})`);
  output.setMimeType(ContentService.MimeType.JAVASCRIPT);
  return output;
}
